Bootstrap: docker
From: nvidia/cuda:11.3.1-cudnn8-devel-ubuntu20.04

%files
    environment.yml             /opt/openfold/environment.yml
    environment_aarch64.yml             /opt/openfold/environment_aarch64.yml
    openfold                    /opt/openfold/openfold
    scripts                     /opt/openfold/scripts
    run_pretrained_openfold.py  /opt/openfold/run_pretrained_openfold.py
    train_openfold.py           /opt/openfold/train_openfold.py
    setup.py                    /opt/openfold/setup.py

%post
    export DEBIAN_FRONTEND=noninteractive
    # Add your installation steps
    apt-get update && apt-get install -y \
        wget \
        libxml2 \
        cuda-minimal-build-11-3 \
        libcusparse-dev-11-3 \
        libcublas-dev-11-3 \
        libcusolver-dev-11-3 \
        git
    
    wget -P /tmp \
        "https://github.com/conda-forge/miniforge/releases/download/23.3.1-1/Miniforge3-$(uname)-$(uname -m).sh"
    
    bash /tmp/Miniforge3-$(uname)-$(uname -m).sh -b -p /opt/conda
    rm /tmp/Miniforge3-$(uname)-$(uname -m).sh
    export PATH=/opt/conda/bin:$PATH
    
    conda env update -n base --file /opt/openfold/environment_aarch64_aarch64.yml
    export LD_LIBRARY_PATH=${CONDA_PREFIX}/lib:${LD_LIBRARY_PATH}
    
    # Download additional resource
    wget -q -P /opt/openfold/openfold/resources \
        https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt
    
    # Install Python packages
    cd /opt/openfold
    python3 setup.py install

runscript
    conda deactivate >/dev/null 2>&1 || true
    exec /bin/bash -i